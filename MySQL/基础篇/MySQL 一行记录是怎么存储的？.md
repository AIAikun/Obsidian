# MySQL 一行记录是怎么存储的？
## MySQL 的数据存放在哪个文件？
MySQL 的数据都是保存在磁盘的。
MySQL 存储的行为是由存储引擎实现的，InnoDB 是我们常用的存储引擎，也是 MySQL 默认的存储引擎。
``` sql
mysql> SHOW VARIABLES LIKE 'datadir';
+---------------+-----------------+
| Variable_name | Value           |
+---------------+-----------------+
| datadir       | /var/lib/mysql/ |
+---------------+-----------------+
1 row in set (0.00 sec)
```
我们每创建一个 database（数据库）都会在 /var/lib/mysql/ 目录里面创建一个以 database 为名的目录，然后保存表结构和表数据的文件都会存放在这个目录里。
![[Pasted image 20250305212907.png]]
可以看到，共有三个文件，这三个文件分别代表着：
 - db.opt
 - t_order.frm，t_order 的**表结构**会保存在这个文件
 - t_order.ibd，t_order 的**表数据**会保存在这个文件。这个文件也称为独占表空间文件。
### 表空间文件的结构是怎么样的？
 **表空间由段（segment）、区（extent）、页（page）、行（row）组成**，InnoDB 存储引擎的逻辑存储结构大致如下图：![[Pasted image 20250305213144.png]]
#### 1 行（row）
#### 2、页（page）
**InnoDB 的数据是按「页」为单位来读写的，默认每个页的大小为 16KB**。
页是 InnoDB 存储引擎磁盘管理的最小单元，意味着数据库每次读写都是以 16KB 为单位的，一次最少从磁盘中读取 16K 的内容到内存中，一次最少把内存中的 16K 内容刷新到磁盘中。
#### 3、区（extent）
 InnoDB 存储引擎是用 B+ 树来组织数据的。
 **在表中数据量大的时候，为某个索引分配空间的时候就不再按照页为单位分配了，而是按照区（extent）为单位分配。每个区的大小为 1MB，对于  16KB 的页来说，连续的 64 个页会被划为一个区，这样就使得链表中相邻的页的物理位置也相邻，就能使用顺序 I/O 了**。
#### 4. 段（segment）
表空间是由各个段（segment）组成的，段是由多个区（extent）组成的。段一般分为数据段、索引段和回滚段等。
- 索引段：存放 B + 树的非叶子节点的区的集合；
- 数据段：存放 B + 树的叶子节点的区的集合；
- 回滚段：存放的是回滚数据的区的集合。
## InnoDB 行格式有哪些？
行格式（row_format），就是一条记录的存储结构。InnoDB 主要用的是Compact、Dynamic 和 Compressed 行格式（三者格式很像）。
## COMPACT 行格式长什么样？
一条完整的记录分为「记录的额外信息」和「记录的真实数据」两个部分。
![[Pasted image 20250305214258.png]]
### 记录的额外信息
#### 1. 变长字段长度列表
varchar(n) 和 char(n)：char 是定长的，varchar 是变长的，所以在存储数据的时候，也要把数据占用的大小存起来，存到「变长字段长度列表」里面
这些变长字段的真实数据占用的字节数会按照列的顺序**逆序存放**，**NULL 是不会存放在行格式中记录的真实数据部分里的，所以「变长字段长度列表」里不需要保存值为  NULL 的变长字段的长度。**![[Pasted image 20250305215810.png]]
